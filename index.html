<!DOCTYPE html>
<html>
<head>
<title>Online Voting System</title>

<style>
body {
  font-family: Arial;
  background:#95edda;
  text-align:center;
  margin:0;
}

input, textarea, select {
  padding:8px;
  margin:5px;
  width:260px;
}

button {
  padding:8px 14px;
  margin:4px;
  cursor:pointer;
}

.section {
  display:none;
  background:#a3fffd;
  padding:20px;
  margin:40px auto;
  width:520px;
  border-radius:6px;
}

h2 { color:#333; }
hr { margin:15px 0; }

.danger {
  background:#ff0000;
  color:rgb(0, 0, 0);
}

.small { font-size:13px; }

/* üî• DASHBOARD BACKGROUND IMAGE */
#dashboard {
  display:block;
  background: url('dashboard.jpg') no-repeat center center/cover;
  color:rgb(164, 232, 252);
  min-height:70vh;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
}

/* Dashboard content box */
#dashboard input,
#dashboard select {
  background: rgb(164, 232, 252);
  color:black;
}

#dashboard h2 {
  color:rgb(164, 232, 252);
}
</style>
</head>

<body>

<h1>Online Voting System</h1>

<!-- DASHBOARD -->
<div class="section" id="dashboard" style="display:block">
  <h2>Login</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPass" type="password" placeholder="Password">
  <select id="loginRole">
    <option value="voter">Voter</option>
    <option value="candidate">Candidate</option>
    <option value="admin">Admin</option>
  </select><br>
  <button onclick="login()">Login</button>
  <button onclick="show('register')">Register</button>
</div>

<!-- REGISTER -->
<div class="section" id="register">
  <h2>Register</h2>
  <input id="rname" placeholder="Name">
  <input id="remail" placeholder="VIT Email">
  <input id="rpass" type="password" placeholder="Password">
  <select id="rrole">
    <option value="voter">Voter</option>
    <option value="candidate">Candidate</option>
  </select><br>
  <button onclick="register()">Submit</button>
  <button onclick="show('dashboard')">Back</button>
</div>

<!-- VOTER -->
<div class="section" id="voter">
  <h2>Voter Panel</h2>
  <div id="candidateList"></div>
  <button onclick="logout()">Logout</button>
</div>

<!-- CANDIDATE -->
<div class="section" id="candidate">
  <h2>Candidate Panel</h2>
  <textarea id="manifesto" placeholder="Enter manifesto"></textarea><br>
  <button onclick="saveManifesto()">Save Manifesto</button>
  <p id="candMsg"></p>
  <button onclick="logout()">Logout</button>
</div>

<!-- ADMIN -->
<div class="section" id="admin">
  <h2>Admin Panel</h2>

  <h3>Voters (Remove Option)</h3>
  <table border="1" width="100%" cellpadding="5">
  <thead>
    <tr>
      <th>Sr. No</th>
      <th>Name</th>
      <th>Email</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="voterList"></tbody>
</table>


  <hr>

  <h3>Candidates (Remove Option)</h3>
  <div id="candidateAdminList"></div>

  <hr>

  <h3>Votes Per Candidate</h3>
  <div id="voteCount"></div>

  <hr>

  <h3>Election Result</h3>
  <div id="winnerResult"></div>

  <hr>

  <h3>Voting Details</h3>
  <div id="voteDetails"></div>

  <hr>

  <h3>Election Control</h3>
  <button class="danger" onclick="reElection()">Re-Election</button>

  <br><br>
  <button onclick="logout()">Logout</button>
</div>

<script>
let users = JSON.parse(localStorage.getItem("users") || "[]");
let votes = JSON.parse(localStorage.getItem("votes") || "[]");
let currentUser = null;

/* UTIL */
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}
function logout(){ currentUser=null; show("dashboard"); }

/* REGISTER */
function register(){
  if(!remail.value.endsWith("@vit.edu"))
    return alert("Only VIT email allowed");

  users.push({
    name:rname.value,
    email:remail.value,
    pass:rpass.value,
    role:rrole.value,
    voted:false,
    manifesto:""
  });
  localStorage.setItem("users",JSON.stringify(users));
  alert("Registered successfully");
  show("dashboard");
}

/* LOGIN */
function login(){
  let email=loginEmail.value;
  let pass=loginPass.value;
  let role=loginRole.value;

  if(role==="admin"){
    if(email==="kalpeshborse9921@gmail.com" && pass==="Kal@pesh123"){
      show("admin"); loadAdmin();
      return;
    }
    return alert("Invalid admin login");
  }

  let user = users.find(u=>u.email===email && u.pass===pass && u.role===role);
  if(!user) return alert("Invalid login");

  currentUser=user;
  role==="voter" ? (show("voter"), loadCandidates()) :
  (show("candidate"));
}

/* VOTER */
function loadCandidates(){
  let div=candidateList;
  div.innerHTML="";
  if(currentUser.voted) return div.innerHTML="You already voted";

  let cands=users.filter(u=>u.role==="candidate");
  if(cands.length===0) return div.innerHTML="No candidates available";

  cands.forEach(c=>{
    div.innerHTML+=`
      <input type="radio" name="vote" value="${c.email}"> ${c.name}<br>`;
  });
  div.innerHTML+=`<button onclick="vote()">Vote</button>`;
}
function vote(){
  let c=document.querySelector('input[name="vote"]:checked');
  if(!c) return alert("Select a candidate");

  votes.push({voter:currentUser.email,candidate:c.value});
  currentUser.voted=true;

  localStorage.setItem("votes",JSON.stringify(votes));
  localStorage.setItem("users",JSON.stringify(users));
  alert("Vote submitted");
  loadCandidates();
}

/* CANDIDATE */
function saveManifesto(){
  currentUser.manifesto=manifesto.value;
  localStorage.setItem("users",JSON.stringify(users));
  candMsg.innerHTML="Manifesto saved";
}

/* ADMIN */
function loadAdmin(){
  loadVoters();
  loadCandidatesAdmin();
  loadVoteCount();
  loadWinner();
  loadVoteDetails();
}

/* ADMIN ‚Äì VOTERS */
function loadVoters(){
  voterList.innerHTML = "";

  let voters = users.filter(u => u.role === "voter");

  if(voters.length === 0){
    voterList.innerHTML = `
      <tr>
        <td colspan="4">No voters registered</td>
      </tr>
    `;
    return;
  }

  voters.forEach((v, index) => {
    voterList.innerHTML += `
      <tr>
        <td>${index + 1}</td>
        <td>${v.name}</td>
        <td>${v.email}</td>
        <td>
          <button class="danger small" onclick="removeVoter('${v.email}')">
            Remove
          </button>
        </td>
      </tr>
    `;
  });
}

function removeVoter(email){
  if(!confirm("Remove this voter?")) return;
  users = users.filter(u=>u.email!==email);
  votes = votes.filter(v=>v.voter!==email);
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("votes",JSON.stringify(votes));
  loadAdmin();
}

/* ADMIN ‚Äì CANDIDATES */
function loadCandidatesAdmin(){
  candidateAdminList.innerHTML="";
  users.filter(u=>u.role==="candidate").forEach(c=>{
    candidateAdminList.innerHTML+=`
      ${c.name} (${c.email})
      <button class="danger small" onclick="removeCandidate('${c.email}')">Remove</button><br>`;
  });
}
function removeCandidate(email){
  if(!confirm("Remove this candidate?")) return;
  users = users.filter(u=>u.email!==email);
  votes = votes.filter(v=>v.candidate!==email);
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("votes",JSON.stringify(votes));
  loadAdmin();
}

/* RESULTS */
function loadVoteCount(){
  voteCount.innerHTML="";
  users.filter(u=>u.role==="candidate").forEach(c=>{
    let count=votes.filter(v=>v.candidate===c.email).length;
    voteCount.innerHTML+=`${c.name} : ${count} votes<br>`;
  });
}

function loadWinner(){
  let candidates = users.filter(u => u.role === "candidate");

  if(candidates.length === 0){
    winnerResult.innerHTML = "No candidates available";
    return;
  }

  let result = candidates.map(c => ({
    name: c.name,
    email: c.email,
    votes: votes.filter(v => v.candidate === c.email).length
  }));

  result.sort((a,b) => b.votes - a.votes);

  if(result[0].votes === 0){
    winnerResult.innerHTML = "No votes cast yet";
    return;
  }

  // üî• TIE CHECK
  let topVotes = result[0].votes;
  let tiedCandidates = result.filter(r => r.votes === topVotes);

  if(tiedCandidates.length > 1){
    winnerResult.innerHTML = `
      ‚ö† <b>No Winner</b><br>
      Election Tied between ${tiedCandidates.length} candidates<br>
      üó≥ Votes each: ${topVotes}
    `;
    return;
  }

  // ‚úÖ CLEAR WINNER
  let winner = result[0];
  let runnerUpVotes = result[1] ? result[1].votes : 0;
  let margin = winner.votes - runnerUpVotes;

  winnerResult.innerHTML = `
    üèÜ <b>Winner:</b> ${winner.name}<br>
    üó≥ <b>Total Votes:</b> ${winner.votes}<br>
    üìä <b>Winning Margin:</b> ${margin} vote(s)
  `;
}

function loadVoteDetails(){
  voteDetails.innerHTML="";
  if(votes.length===0) return voteDetails.innerHTML="No votes yet";
  votes.forEach(v=>{
    voteDetails.innerHTML+=`${v.voter} voted for ${v.candidate}<br>`;
  });
}

/* RE-ELECTION */
function reElection(){
  if(!confirm("Delete all candidates and votes?")) return;
  users = users.filter(u=>u.role!=="candidate");
  users.forEach(u=>{ if(u.role==="voter") u.voted=false; });
  votes=[];
  localStorage.setItem("users",JSON.stringify(users));
  localStorage.setItem("votes",JSON.stringify(votes));
  loadAdmin();
}
</script>

</body>
</html>

